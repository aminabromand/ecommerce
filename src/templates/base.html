{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    {% include 'base/css.html' %}
    {% block base_head %}{% endblock %}

    <title>Hello, world!</title>
  </head>
  <body>
    
    {% include 'base/navbar.html' with brand_name='eCommerce' %}

    <div class='container'>
    
      {% block content %}{% endblock %}

    </div>

    {% include 'base/js.html' %}

    <script>
      $(document).ready(function() {

        // Auto Search
        var searchForm = $(".search-form");
        var searchInput = searchForm.find("[name='q']"); // input name='q'
        var typingTimer;
        var searchingTimer;
        var typingInterval = 500; // .5 seconds
        var searchBtn = searchForm.find("[type='submit']");

        searchInput.keyup(function(event) {
          // console.log(searchInput.val());
          clearTimeout(typingTimer);
          typingTimer = setTimeout(performSearch, typingInterval);
        });

        searchInput.keydown(function(event) {
          clearTimeout(typingTimer);
        })

        function displaySearching() {
          searchBtn.addClass("disabled");
          //searchBtn.html("<i class='fas fa-spinner'></i> Searching...");
          searchBtn.html("<i class='fa fa-spin fa-spinner'></i> Searching...");
        }

        function performSearch() {
          displaySearching();
          var query = searchInput.val();
          searchingTimer = setTimeout(function() {
            window.location.href='/search/?q=' + query;
          }, typingInterval);
        }







        // Cart + Add Products
        var productForm = $(".form-product-ajax"); // #form-product-ajax
        productForm.submit(function(event) {
          event.preventDefault();
          console.log("Form is not sending");
          var thisForm = $(this)
          var actionEndpoint;
          var httpMethod;
          var formData;

          // actionEndpoint = thisForm.attr("action"); // API Endpoint
          actionEndpoint = thisForm.attr("data-endpoint");
          httpMethod = thisForm.attr("method");
          formData = thisForm.serialize();
          console.log(actionEndpoint, httpMethod);

          $.ajax({
            url: actionEndpoint,
            method: httpMethod,
            data: formData,
            success: function(data) {
              var submitSpan = thisForm.find(".submit-span");
              if (data.added) {
                submitSpan.html("In cart <button type='submit' class='btn btn-link'>Remove?</button>");
              } else {
                submitSpan.html("<button class='btn btn-success'>Add to cart</button>");
              }
              var navbarCount = $(".navbar-cart-count");
              navbarCount.text(data.cart_item_count);
              var currentPath = window.location.href;
              if (currentPath.indexOf("cart") != -1) {
                refreshCart(data.removed, data.cart_product_id);
              }
            },
            error: function(errorData) {
              console.log("ajax error: ", errorData);
            }
          });

        });

        function refreshCart(removed, cart_product_id) {
          console.log("in current cart");
          var cartTable = $(".cart-table");
          var cartTableBody = cartTable.find(".cart-table-body");
          //cartTableBody.html("<h1>Changed</h1>")
          var cartProducts = cartTableBody.find(".cart-product");
          var currentUrl = window.location.href;

          if (removed) {
            var cartProductToRemoveClass = ".cart-product-id-" + cart_product_id;
            var cartProductToRemove = cartTableBody.find(cartProductToRemoveClass);
            cartProductToRemove.remove();
          }

          var refreshCartUrl = '/api/cart/';
          var refreshCartMethod = "GET";
          var data = {};
          $.ajax({
            url: refreshCartUrl,
            method: refreshCartMethod,
            data: data,
            success: function(data) {
              console.log("success");
              console.log(data);
              var hiddenCartItemRemoveForm = $(".cart-item-remove-form");
              if (data.products.length > 0) {
                //cartProducts.html("<tr><td colspan=3>Coming Soon</td></tr>");
                // cartProducts.remove();
                // i = data.products.length;
                // $.each(data.products, function(index, value) {
                //   var newCartItemRemove = hiddenCartItemRemoveForm.clone();
                //   newCartItemRemove.css("display", "block");
                //   // newCartItemRemove.removeClass("hiden-class");
                //   newCartItemRemove.find(".cart-item-product-id").val(value.id);
                //   cartTableBody.prepend("<tr><th scope=\"row\">" + i + "</th><td><a href='" + value.url + "'>" + value.name + "</a>" + newCartItemRemove.html() + "</td><td>" + value.price + "</td></tr>");
                //   i--;
                // });
                cartTableBody.find(".cart-subtotal").text(data.subtotal);
                cartTableBody.find(".cart-total").text(data.total);
              } else {
                window.location.href = currentUrl;
              }
            },
            error: function(errorData) {
              console.log("error");
              console.log(errorData);
            }
          });
        }
      });
    </script>

  </body>
</html>